

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>telecom.command &#8212; docker-telegram-bot  documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">docker-telegram-bot  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for telecom.command</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Implementation of command related abstract classes and functions.</span>

<span class="sd">A *command* is a message of the form ``/commandName`` issued to the bot over</span>
<span class="sd">telegram. In Python, it is represented by a subclass of</span>
<span class="sd">:py:class:`telecom.command.Command` that implements</span>
<span class="sd">:py:meth:`telecom.command.Command.main`.</span>

<span class="sd">See :py:class:`telecom.Command` for more documentation, and</span>
<span class="sd">:py:class:`cmd_hi.Hi` for an example.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">auto</span><span class="p">,</span>
    <span class="n">IntEnum</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">telegram</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Bot</span><span class="p">,</span>
    <span class="n">Message</span><span class="p">,</span>
    <span class="n">ParseMode</span><span class="p">,</span>
    <span class="n">Update</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">telegram.constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">MAX_MESSAGE_LENGTH</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CommandHandler</span><span class="p">,</span>
    <span class="n">Dispatcher</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">telegram.ext.filters</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Filters</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">telecom.selector</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ArgumentSelector</span>
<span class="p">)</span>


<span class="n">COMMANDS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="s1">&#39;Command&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="sd">&quot;&quot;&quot;Dictionary that maps a command name to the corresponding class.</span>

<span class="sd">See :py:meth:`telecom.command.register_command`.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="NotEnoughArguments"><a class="viewcode-back" href="../../telecom.html#telecom.command.NotEnoughArguments">[docs]</a><span class="k">class</span> <span class="nc">NotEnoughArguments</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This exception is raised when a command doesn&#39;t have enough argument.</span>

<span class="sd">    It is caught by :py:meth:`telecom.command.Command.__call__`, so in</span>
<span class="sd">    practice, it just interrupts the execution flow.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Command"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command">[docs]</a><span class="k">class</span> <span class="nc">Command</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class represent an abstract command that can be issued over</span>
<span class="sd">    telegram.</span>

<span class="sd">    Simply derive this class and implement</span>
<span class="sd">    :py:meth:`telecom.command.Command.main`. A help message can be stored in</span>
<span class="sd">    class static member :py:meth:`telecom.command.Command.__HELP__`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Command.HookType"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.HookType">[docs]</a>    <span class="k">class</span> <span class="nc">HookType</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hook types.</span>

<span class="sd">        A hook is a function called at certain points of the execution of a</span>
<span class="sd">        command. They are added using</span>
<span class="sd">        :py:meth:`telecom.command.add_command_hook`. There can be multiple</span>
<span class="sd">        functions per hook.</span>

<span class="sd">        The currently supported hook types are:</span>
<span class="sd">            * ``ON_CALLED_FOR_THE_FIRST_TIME``: when the command instance is</span>
<span class="sd">              called for the first time;</span>
<span class="sd">            * ``ON_CALLED_NOT_FOR_THE_FIRST_TIME``: when the command instance is</span>
<span class="sd">               called but not for the first time;</span>
<span class="sd">            * ``ON_CREATED``: when the command instance is created;</span>
<span class="sd">            * ``ON_FINISHED``: when the command instance finishes execution</span>
<span class="sd">               **normally**;</span>
<span class="sd">            * ``ON_NOT_ENOUGH_ARGUMENTS``: when the execution of the command is</span>
<span class="sd">              interrupted because of missing arguments;</span>
<span class="sd">            * ``ON_RAISED_EXCEPTION``: when an exception (other than</span>
<span class="sd">              :py:class:`telecom.command.NotEnoughArguments`) is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ON_CALLED_FOR_THE_FIRST_TIME</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">ON_CALLED_NOT_FOR_THE_FIRST_TIME</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">ON_CREATED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">ON_FINISHED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">ON_NOT_ENOUGH_ARGUMENTS</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">ON_RAISED_EXCEPTION</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span></div>


    <span class="n">PENDING_COMMANDS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;Global dict of pending commands.&quot;&quot;&quot;</span>

    <span class="n">PENDING_COMMANDS_COUNTER</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="sd">&quot;&quot;&quot;A global counter that is incremented each a new pending command is added</span>
<span class="sd">    to :py:attr:`telecom.command.Command.PENDING_COMMANDS`.&quot;&quot;&quot;</span>

    <span class="n">GLOBAL_HOOKS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">HookType</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s1">&#39;Command&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;A global dict containing all hooks.&quot;&quot;&quot;</span>

    <span class="n">__HELP__</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Help text of that command.&quot;&quot;&quot;</span>

    <span class="n">_args_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Argument dict.&quot;&quot;&quot;</span>

    <span class="n">_bot</span><span class="p">:</span> <span class="n">Bot</span>
    <span class="sd">&quot;&quot;&quot;Telegram bot that called this command.&quot;&quot;&quot;</span>

    <span class="n">_first_call</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Wether this is the first time this command instance is called.&quot;&quot;&quot;</span>

    <span class="n">_message</span><span class="p">:</span> <span class="n">Message</span>
    <span class="sd">&quot;&quot;&quot;Either the user message that called this command, or the last message</span>
<span class="sd">    the command sent.&quot;&quot;&quot;</span>

    <span class="n">_pending_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Key of this command in</span>
<span class="sd">    :py:attr:`telecom.command.Command.PENDING_COMMANDS`, or ``None`` if the</span>
<span class="sd">    command is not pending.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Command.__call__"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">bot</span><span class="p">:</span> <span class="n">Bot</span><span class="p">,</span>
                 <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span>
                 <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The command is called through this method by the telegram dispatcher.</span>

<span class="sd">        Do not reimplement this. It calls hooks and catches</span>
<span class="sd">        :py:class:`telecom.command.NotEnoughArguments` exceptions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_call</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span> <span class="o">=</span> <span class="n">bot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_call</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_hooks</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">HookType</span><span class="o">.</span><span class="n">ON_CALLED_FOR_THE_FIRST_TIME</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_hooks</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">HookType</span><span class="o">.</span><span class="n">ON_CALLED_NOT_FOR_THE_FIRST_TIME</span><span class="p">)</span>

        <span class="n">kwargs_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">kwargs_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span> <span class="n">val</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="n">kwargs_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_dict</span> <span class="o">=</span> <span class="n">kwargs_dict</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">NotEnoughArguments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_hooks</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">HookType</span><span class="o">.</span><span class="n">ON_NOT_ENOUGH_ARGUMENTS</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_hooks</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">HookType</span><span class="o">.</span><span class="n">ON_RAISED_EXCEPTION</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_idx</span> <span class="ow">in</span> <span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS</span><span class="p">:</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_hooks</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">HookType</span><span class="o">.</span><span class="n">ON_FINISHED</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_call</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hooks</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">HookType</span><span class="o">.</span><span class="n">ON_CREATED</span><span class="p">)</span>

<div class="viewcode-block" id="Command.arg"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.arg">[docs]</a>    <span class="k">def</span> <span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">arg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">selector</span><span class="p">:</span> <span class="n">ArgumentSelector</span><span class="p">,</span>
            <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Select an option:&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the value of an argument.</span>

<span class="sd">        If the argument is not available, the selector displays an inline</span>
<span class="sd">        keyboard, and the command instance raises a</span>
<span class="sd">        :py:class:`telecom.command.NotEnoughArguments` exception instance so as</span>
<span class="sd">        to be stored in :py:attr:`telecom.Command.PENDING_COMMANDS` (see</span>
<span class="sd">        :py:meth:`telecom.command.Command.__call__`) waiting to be called again</span>
<span class="sd">        with the missing argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_dict</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_idx</span><span class="p">:</span>
            <span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS_COUNTER</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS_COUNTER</span><span class="p">)</span>
            <span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">selector</span><span class="o">.</span><span class="n">option_inline_keyboard</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self._pending_idx}</span><span class="s1">:</span><span class="si">{arg_name}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">NotEnoughArguments</span></div>

<div class="viewcode-block" id="Command.call_hooks"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.call_hooks">[docs]</a>    <span class="k">def</span> <span class="nf">call_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_type</span><span class="p">:</span> <span class="n">HookType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls all hooks of a given type.</span>

<span class="sd">        Hooks are called in the order they have been added using</span>
<span class="sd">        :py:meth:`telecom.command.add_command_hook`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">Command</span><span class="o">.</span><span class="n">GLOBAL_HOOKS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hook_type</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Command.delete_reply"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.delete_reply">[docs]</a>    <span class="k">def</span> <span class="nf">delete_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes the last message sent by this command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">delete_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="o">.</span><span class="n">chat_id</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Command.edit_reply"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.edit_reply">[docs]</a>    <span class="k">def</span> <span class="nf">edit_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Edits the last message sent by this command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Command.main"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.main">[docs]</a>    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Main code of the command.</span>

<span class="sd">        This function may be executed multiple times even if the telegram user</span>
<span class="sd">        invokes it once. This is due to the execution flow breaking</span>
<span class="sd">        :py:class:`telecom.command.NotEnoughArgument` that is raised when</span>
<span class="sd">        missing arguments are requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Command.reply"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.reply">[docs]</a>    <span class="k">def</span> <span class="nf">reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sends a markdown message through telegram.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_bytes</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_bytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_MESSAGE_LENGTH</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">...&#39;</span>
            <span class="n">text_bytes</span> <span class="o">=</span> <span class="n">text_bytes</span><span class="p">[:</span><span class="n">MAX_MESSAGE_LENGTH</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">end</span><span class="p">)]</span> <span class="o">+</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
            <span class="n">chat_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="o">.</span><span class="n">chat_id</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="n">reply_to_message_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Command.reply_error"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.reply_error">[docs]</a>    <span class="k">def</span> <span class="nf">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reports an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;User &quot;</span><span class="si">%s</span><span class="s1">&quot; raised an error: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;❌ *ERROR* ❌</span><span class="se">\n</span><span class="si">{text}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Command.reply_warning"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.reply_warning">[docs]</a>    <span class="k">def</span> <span class="nf">reply_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reports an warning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;User &quot;</span><span class="si">%s</span><span class="s1">&quot; raised a warning: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;⚠️ *WARNING* ⚠️</span><span class="se">\n</span><span class="si">{text}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Command.set_arg"><a class="viewcode-back" href="../../telecom.html#telecom.command.Command.set_arg">[docs]</a>    <span class="k">def</span> <span class="nf">set_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sets the value of an argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_dict</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg_value</span></div></div>



<div class="viewcode-block" id="Help"><a class="viewcode-back" href="../../telecom.html#telecom.command.Help">[docs]</a><span class="k">class</span> <span class="nc">Help</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implentation of builtin command `/help`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__HELP__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;▪️ Usage: `/help COMMAND`</span>
<span class="s2">Displays help message of a command.&quot;&quot;&quot;</span>

    <span class="n">HELP_DICT</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;Dictionary that maps a command name to its help text.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Help.CommandSelector"><a class="viewcode-back" href="../../telecom.html#telecom.command.Help.CommandSelector">[docs]</a>    <span class="k">class</span> <span class="nc">CommandSelector</span><span class="p">(</span><span class="n">ArgumentSelector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects a command name among all registered commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Help.CommandSelector.option_list"><a class="viewcode-back" href="../../telecom.html#telecom.command.Help.CommandSelector.option_list">[docs]</a>        <span class="k">def</span> <span class="nf">option_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">command_name</span><span class="p">,</span> <span class="n">command_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">command_name</span> <span class="ow">in</span> <span class="n">Help</span><span class="o">.</span><span class="n">HELP_DICT</span>
            <span class="p">]</span></div></div>

<div class="viewcode-block" id="Help.main"><a class="viewcode-back" href="../../telecom.html#telecom.command.Help.main">[docs]</a>    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">command_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span>
            <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="n">Help</span><span class="o">.</span><span class="n">CommandSelector</span><span class="p">(),</span>
            <span class="s2">&quot;Choose a command:&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">command_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Help</span><span class="o">.</span><span class="n">HELP_DICT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Command `</span><span class="si">{command_name}</span><span class="s1">` not found.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">command_doc</span> <span class="o">=</span> <span class="n">Help</span><span class="o">.</span><span class="n">HELP_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;No help available for command `</span><span class="si">{command_name}</span><span class="s1">`.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;🆘 *Help for command* `</span><span class="si">{command_name}</span><span class="s1">` 🆘</span><span class="se">\n</span><span class="si">{command_doc}</span><span class="s1">&#39;</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="add_command_hook"><a class="viewcode-back" href="../../telecom.html#telecom.command.add_command_hook">[docs]</a><span class="k">def</span> <span class="nf">add_command_hook</span><span class="p">(</span><span class="n">hook_type</span><span class="p">:</span> <span class="n">Command</span><span class="o">.</span><span class="n">HookType</span><span class="p">,</span>
                     <span class="n">hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Command</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Adds a global command hook.</span>

<span class="sd">    See :py:attr:`telecom.command.Command.GLOBAL_HOOKS` and</span>
<span class="sd">    :py:meth:`telecom.command.Command.call_hooks`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Command</span><span class="o">.</span><span class="n">GLOBAL_HOOKS</span><span class="p">[</span><span class="n">hook_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">hook</span><span class="p">]</span> <span class="o">+</span> \
        <span class="nb">list</span><span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">GLOBAL_HOOKS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hook_type</span><span class="p">,</span> <span class="p">[]))</span></div>


<div class="viewcode-block" id="inline_query_handler"><a class="viewcode-back" href="../../telecom.html#telecom.command.inline_query_handler">[docs]</a><span class="k">def</span> <span class="nf">inline_query_handler</span><span class="p">(</span><span class="n">bot</span><span class="p">:</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Global inline query handler.</span>

<span class="sd">    Register it to a telegram dispatcher as such::</span>

<span class="sd">        updater = Updater(token=token)</span>
<span class="sd">        dispatcher = updater.dispatcher</span>
<span class="sd">        dispatcher.add_handler(CallbackQueryHandler(inline_query_handler))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received callback query </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">call_idx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">arg_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">arg_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">call_idx</span> <span class="ow">in</span> <span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS</span><span class="p">:</span>
        <span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS</span><span class="p">[</span><span class="n">call_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_arg</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span><span class="p">)</span>
        <span class="n">Command</span><span class="o">.</span><span class="n">PENDING_COMMANDS</span><span class="p">[</span><span class="n">call_idx</span><span class="p">](</span><span class="n">bot</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Bad call index </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">call_idx</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_command"><a class="viewcode-back" href="../../telecom.html#telecom.command.register_command">[docs]</a><span class="k">def</span> <span class="nf">register_command</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">:</span> <span class="n">Dispatcher</span><span class="p">,</span>
                     <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">command_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Command</span><span class="p">],</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Registers a new command.</span>

<span class="sd">    Args:</span>
<span class="sd">        dispatcher : telegram.ext.Dispatcher</span>
<span class="sd">            Telegram dispatcher.</span>
<span class="sd">        command_name : str</span>
<span class="sd">            Command name.</span>
<span class="sd">        command_class : type</span>
<span class="sd">            Class where the command is implemented.</span>
<span class="sd">        defaults : Dict[str, Any]</span>
<span class="sd">            Defaults arguments to be passed to the instances of that command.</span>
<span class="sd">        authorized_users : List[int]</span>
<span class="sd">            List of users authorized to call this command; if none provided, all</span>
<span class="sd">            users are authorized</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">command_class</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Registering command </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command_name</span><span class="p">)</span>

    <span class="n">COMMANDS</span><span class="p">[</span><span class="n">command_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_class</span>
    <span class="n">Help</span><span class="o">.</span><span class="n">HELP_DICT</span><span class="p">[</span><span class="n">command_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_class</span><span class="o">.</span><span class="n">__HELP__</span>

    <span class="n">authorized_users</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authorized_users&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">command_filters</span> <span class="o">=</span> <span class="n">Filters</span><span class="o">.</span><span class="n">command</span>
    <span class="k">if</span> <span class="n">authorized_users</span><span class="p">:</span>
        <span class="n">command_filters</span> <span class="o">&amp;=</span> <span class="n">Filters</span><span class="o">.</span><span class="n">user</span><span class="p">(</span><span class="n">authorized_users</span><span class="p">)</span>

    <span class="n">dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
        <span class="n">CommandHandler</span><span class="p">(</span>
            <span class="n">command_name</span><span class="p">,</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;defaults&quot;</span><span class="p">,</span> <span class="p">{}))),</span>
            <span class="n">pass_args</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">command_filters</span>
        <span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="register_help_command"><a class="viewcode-back" href="../../telecom.html#telecom.command.register_help_command">[docs]</a><span class="k">def</span> <span class="nf">register_help_command</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">:</span> <span class="n">Dispatcher</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Registers builtin help command.</span>

<span class="sd">    See :py:class:`telecom.command.Help`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">register_command</span><span class="p">(</span>
        <span class="n">dispatcher</span><span class="p">,</span>
        <span class="s2">&quot;help&quot;</span><span class="p">,</span>
        <span class="n">Help</span>
    <span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">docker-telegram-bot  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Cédric HT.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
    </div>
  </body>
</html>